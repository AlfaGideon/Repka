<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –†–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ —Ä—É—Å—Å–∫–æ–º—É</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 420px; margin: 24px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; padding: 18px 10px 24px 10px; }
        h1 { color: #2d3a4b; font-size: 1.5em; }
        h2 { font-size: 1.1em; margin-bottom: 0.2em; }
        .theme-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 18px; }
        .theme-btn { background: #e3eaff; color: #2d3a4b; border: none; padding: 8px 14px; border-radius: 6px; font-size: 1em; cursor: pointer; }
        .theme-btn.selected, .theme-btn:hover { background: #4a90e2; color: #fff; }
        .lesson-block { background: #f0f4fa; border-radius: 8px; padding: 10px 12px; margin-bottom: 18px; }
        .question-block { margin-bottom: 18px; }
        .options { display: flex; flex-direction: column; gap: 8px; }
        .option-btn { background: #4a90e2; color: #fff; border: none; padding: 10px 16px; border-radius: 6px; font-size: 1em; cursor: pointer; }
        .option-btn:hover { background: #357ab8; }
        .result { margin-top: 12px; font-weight: bold; }
        .score { margin: 10px 0; font-size: 1.1em; }
        .history-block { background: #f9f9f9; border-radius: 8px; padding: 10px; margin-top: 18px; }
        .mini-game { margin: 18px 0; }
        .profile { margin: 10px 0 18px 0; font-size: 1em; }
        .send-btn { background: #27ae60; color: #fff; border: none; padding: 10px 18px; border-radius: 6px; font-size: 1em; cursor: pointer; margin-top: 10px; }
        .send-btn:hover { background: #219150; }
        @media (max-width: 500px) {
            .container { max-width: 98vw; padding: 6vw 2vw; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–†–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ —Ä—É—Å—Å–∫–æ–º—É —è–∑—ã–∫—É</h1>
    <div class="profile" id="profile"></div>
    <div id="achievements" style="margin-bottom:10px;"></div>
        <div class="theme-list" id="theme-list"></div>
        <div class="lesson-block" id="lesson-block"></div>
        <div class="question-block" id="question-block"></div>
        <div class="score" id="score"></div>
        <div class="result" id="result"></div>
        <button class="send-btn" id="send-btn" style="display:none">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–æ—Ç—É</button>
        <div class="mini-game" id="mini-game"></div>
    <div class="history-block" id="history-block"></div>
    <div id="add-question-block" style="margin-top:18px;"></div>
    </div>
    <script>
    // --- Telegram WebApp API ---
    let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

    // --- User profile (local only) ---
    function getProfile() {
        let name = localStorage.getItem('ruapp_name') || '';
        if (!name) {
            name = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞:') || '–£—á–µ–Ω–∏–∫';
            localStorage.setItem('ruapp_name', name);
        }
        return name;
    }

    function showProfile() {
        const name = getProfile();
        // –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        const hist = JSON.parse(localStorage.getItem('ruapp_history') || '[]');
        let total = 0, correct = 0;
        hist.forEach(h => { total += h.total; correct += h.score; });
        let progress = total ? ` | –ü—Ä–æ–≥—Ä–µ—Å—Å: ${correct}/${total}` : '';
        let achievements = '';
        if (correct >= 10) achievements += 'üèÖ 10+ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤! ';
        if (hist.length >= 5) achievements += 'üéì 5+ —Ç–µ—Å—Ç–æ–≤! ';
        document.getElementById('profile').textContent = `üë§ ${name}${progress}`;
        document.getElementById('achievements').textContent = achievements;
    }

    // --- Load questions ---
    let questionsData = [];
    fetch('questions.json')
        .then(r => r.json())
        .then(data => {
            questionsData = data;
            showThemes();
            showProfile();
            showHistory();
        });

    // --- Theme selection ---
    let currentTheme = null;
    function showThemes() {
        const themeList = document.getElementById('theme-list');
        themeList.innerHTML = '';
        questionsData.forEach((theme, idx) => {
            const btn = document.createElement('button');
            btn.className = 'theme-btn' + (currentTheme === idx ? ' selected' : '');
            btn.textContent = theme.theme;
            btn.onclick = () => selectTheme(idx);
            themeList.appendChild(btn);
        });
    }
    function selectTheme(idx) {
        currentTheme = idx;
        showThemes();
        startLesson();
    }

    // --- Lesson and test logic ---
    let currentQuestions = [];
    let currentQuestionIdx = 0;
    let score = 0;
    let answers = [];

    function startLesson() {
        const theme = questionsData[currentTheme];
        document.getElementById('lesson-block').innerHTML = `<h2>–£—Ä–æ–∫: ${theme.lesson.title}</h2><div>${theme.lesson.content}</div>`;
        // –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
        currentQuestions = [...theme.questions].sort(() => Math.random() - 0.5);
        currentQuestionIdx = 0;
        score = 0;
        answers = [];
        document.getElementById('result').textContent = '';
        document.getElementById('score').textContent = '';
        document.getElementById('send-btn').style.display = 'none';
        showQuestion();
    }

    function showQuestion() {
        const block = document.getElementById('question-block');
        if (currentQuestionIdx >= currentQuestions.length) {
            finishTest();
            return;
        }
        const q = currentQuestions[currentQuestionIdx];
        let html = `<div><b>–í–æ–ø—Ä–æ—Å ${currentQuestionIdx+1}:</b> ${q.question}</div><div class='options'>`;
        q.options.forEach((opt, i) => {
            html += `<button class='option-btn' onclick='answerQuestion(${i})'>${opt}</button>`;
        });
        html += '</div>';
        block.innerHTML = html;
    }

    window.answerQuestion = function(idx) {
        const q = currentQuestions[currentQuestionIdx];
        const isCorrect = idx === q.answer;
        answers.push({
            question: q.question,
            selected: idx,
            correct: q.answer,
            result: isCorrect
        });
        if (isCorrect) score++;
        document.getElementById('result').textContent = isCorrect ? '–í–µ—Ä–Ω–æ!' : `–ù–µ–≤–µ—Ä–Ω–æ. ${q.explanation}`;
        document.getElementById('result').style.color = isCorrect ? 'green' : 'red';
        setTimeout(() => {
            document.getElementById('result').textContent = '';
            currentQuestionIdx++;
            showQuestion();
        }, 1200);
    }

    function finishTest() {
        document.getElementById('question-block').innerHTML = '';
        document.getElementById('score').textContent = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${score} –∏–∑ ${currentQuestions.length}`;
        document.getElementById('result').textContent = '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!';
        document.getElementById('result').style.color = 'black';
        document.getElementById('send-btn').style.display = 'inline-block';
        saveHistory();
        showHistory();
    }

    // --- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è ---
    function saveHistory() {
        const name = getProfile();
        const theme = questionsData[currentTheme].theme;
        const hist = JSON.parse(localStorage.getItem('ruapp_history') || '[]');
        hist.unshift({
            name, theme, score, total: currentQuestions.length, date: new Date().toLocaleString()
        });
        localStorage.setItem('ruapp_history', JSON.stringify(hist.slice(0, 10)));
    }
    function showHistory() {
        const hist = JSON.parse(localStorage.getItem('ruapp_history') || '[]');
        let html = '<b>–ò—Å—Ç–æ—Ä–∏—è:</b><ul style="padding-left:18px">';
        hist.forEach(h => {
            html += `<li>${h.date}: <b>${h.name}</b> ‚Äî <i>${h.theme}</i> ‚Äî <b>${h.score}/${h.total}</b></li>`;
        });
        html += '</ul>';
        document.getElementById('history-block').innerHTML = html;
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±–æ—Ç—É ---
    document.getElementById('send-btn').onclick = function() {
        if (tg && tg.sendData) {
            tg.sendData(JSON.stringify({
                name: getProfile(),
                theme: questionsData[currentTheme].theme,
                score,
                total: currentQuestions.length,
                answers
            }));
            tg.close && tg.close();
        } else {
            alert('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.');
        }
    };


    // --- –ú–∏–Ω–∏-–∏–≥—Ä–∞: –ù–∞–π–¥–∏ –æ—à–∏–±–∫—É (—Å –ø–æ–¥—Å—á—ë—Ç–æ–º –±–∞–ª–ª–æ–≤) ---
    let miniGameScore = 0;
    function showMiniGame() {
        const block = document.getElementById('mini-game');
        const tasks = [
            { text: '–Ø –ø–æ–µ—Ö–∞–ª –≤ –ú–æ—Å–∫–≤—É –Ω–∞ –ø–æ–µ–∑–¥–µ.', error: false },
            { text: '–û–Ω –ø—Ä–∏—à—ë–ª –¥–æ–º–æ–π, –∏ —Å—Ä–∞–∑—É –ª–µ–≥ —Å–ø–∞—Ç—å.', error: false },
            { text: '–Ø–±–ª–æ–∫–æ —É–ø–∞–ª–æ —Å –¥–µ—Ä–µ–≤–∞.', error: false },
            { text: '–Ø –ª—é–±–ª—é —á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥–∏ –ø–æ –≤–µ—á–µ—Ä–∞–º.', error: false },
            { text: '–Ø –ø–æ—à–æ–ª –≤ –º–∞–≥–∞–∑–∏–Ω.', error: true },
            { text: '–û–Ω–∞ –∫—Ä–∞—Å–∏–≤–∞—è –∏ —É–º–Ω–∞—è.', error: false },
            { text: '–ú–∞–ª—å—á–∏–∫ –∏–≥—Ä–∞–ª –≤ —Ñ—É—Ç–±–æ–ª –Ω–∞ —É–ª–∏—Ü–µ.', error: false },
            { text: '–Ø —Å—å–µ–ª —è–±–ª–æ–∫–æ.', error: true }
        ];
        const task = tasks[Math.floor(Math.random() * tasks.length)];
        block.innerHTML = `<b>–ú–∏–Ω–∏-–∏–≥—Ä–∞: –ù–∞–π–¥–∏ –æ—à–∏–±–∫—É</b> <span style='font-size:0.95em;color:#888'>(–±–∞–ª–ª—ã: <span id='mini-game-score'>${miniGameScore}</span>)</span><div style='margin:8px 0'>${task.text}</div><button class='option-btn' onclick='checkMiniGame(true)'>–ï—Å—Ç—å –æ—à–∏–±–∫–∞</button> <button class='option-btn' onclick='checkMiniGame(false)'>–ù–µ—Ç –æ—à–∏–±–∫–∏</button><div id='mini-game-result'></div>`;
        window._miniGameTask = task;
    }
    window.checkMiniGame = function(ans) {
        const res = document.getElementById('mini-game-result');
        if (ans === window._miniGameTask.error) {
            res.textContent = '–í–µ—Ä–Ω–æ!';
            res.style.color = 'green';
            miniGameScore++;
        } else {
            res.textContent = window._miniGameTask.error ? '–û—à–∏–±–∫–∞ –±—ã–ª–∞!' : '–û—à–∏–±–∫–∏ –Ω–µ –±—ã–ª–æ!';
            res.style.color = 'red';
            if (miniGameScore > 0) miniGameScore--;
        }
        document.getElementById('mini-game-score').textContent = miniGameScore;
        setTimeout(showMiniGame, 1200);
    }
    showMiniGame();


    // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–¥–ª—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞, local only) ---
    function showAddQuestionForm() {
        const block = document.getElementById('add-question-block');
        let html = `<b>–î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å</b><form id='add-q-form' style='margin-top:8px;display:flex;flex-direction:column;gap:6px;'>`;
        html += `<input type='text' id='add-q-theme' placeholder='–¢–µ–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è)' required maxlength='30'>`;
        html += `<input type='text' id='add-q-question' placeholder='–í–æ–ø—Ä–æ—Å' required maxlength='100'>`;
        html += `<input type='text' id='add-q-opt1' placeholder='–í–∞—Ä–∏–∞–Ω—Ç 1' required maxlength='40'>`;
        html += `<input type='text' id='add-q-opt2' placeholder='–í–∞—Ä–∏–∞–Ω—Ç 2' required maxlength='40'>`;
        html += `<input type='number' id='add-q-answer' placeholder='–ù–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ (1 –∏–ª–∏ 2)' min='1' max='2' required>`;
        html += `<input type='text' id='add-q-expl' placeholder='–ü–æ—è—Å–Ω–µ–Ω–∏–µ –∫ –æ—Ç–≤–µ—Ç—É' maxlength='80'>`;
        html += `<button type='submit' class='option-btn'>–î–æ–±–∞–≤–∏—Ç—å</button></form>`;
        block.innerHTML = html;
        document.getElementById('add-q-form').onsubmit = function(e) {
            e.preventDefault();
            const theme = document.getElementById('add-q-theme').value.trim();
            const question = document.getElementById('add-q-question').value.trim();
            const opt1 = document.getElementById('add-q-opt1').value.trim();
            const opt2 = document.getElementById('add-q-opt2').value.trim();
            const answer = parseInt(document.getElementById('add-q-answer').value, 10) - 1;
            const expl = document.getElementById('add-q-expl').value.trim();
            if (!theme || !question || !opt1 || !opt2 || (answer !== 0 && answer !== 1)) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
                return;
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            let custom = JSON.parse(localStorage.getItem('ruapp_custom_questions') || '[]');
            custom.push({ theme, question, options: [opt1, opt2], answer, explanation: expl });
            localStorage.setItem('ruapp_custom_questions', JSON.stringify(custom));
            alert('–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω!');
            showAddQuestionForm();
            loadCustomQuestions();
        };
    }
    showAddQuestionForm();

    // --- –ü–æ–¥–≥—Ä—É–∑–∫–∞ —Å–≤–æ–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ç–µ—Å—Ç—ã ---
    function loadCustomQuestions() {
        let custom = JSON.parse(localStorage.getItem('ruapp_custom_questions') || '[]');
        if (!custom.length) return;
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–µ–º–∞–º
        let byTheme = {};
        custom.forEach(q => {
            if (!byTheme[q.theme]) byTheme[q.theme] = [];
            byTheme[q.theme].push(q);
        });
        // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ç–µ–º–∞–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ
        Object.keys(byTheme).forEach(themeName => {
            let idx = questionsData.findIndex(t => t.theme === themeName);
            if (idx === -1) {
                questionsData.push({ theme: themeName, lesson: { title: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Ç–µ–º–∞', content: '' }, questions: byTheme[themeName] });
            } else {
                questionsData[idx].questions = questionsData[idx].questions.concat(byTheme[themeName]);
            }
        });
        showThemes();
    }

    </script>
</body>
</html>
